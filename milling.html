<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Online Milling Calculator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --success-color: #2ecc71;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f7fa;
      padding: 20px;
    }

    .main-container {
      max-width: 1600px; /* Set your desired max-width */
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .header {
      background-color: var(--secondary-color);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--box-shadow);
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    
    .calculator-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: stretch;
    }
    
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
    }
    
    .card:hover {
      /*transform: translateY(-5px);*/
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .cut-selection {
      flex: 1;
      min-width: 200px;
      max-width: 400px;
      display: flex;
      flex-direction: column;
    }
    
    .inputs {
      flex: 2;
      min-width: 300px;
      max-width: 600px;
    }
    
    .outputs {
      flex: 2;
      min-width: 300px;
      max-width: 600px;
    }
    
    h3 {
      color: var(--secondary-color);
      padding-bottom: 10px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--light-color);
      font-weight: 600;
      font-size: 18px;
    }
    
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      background-color: white;
      /* Increased height to eliminate scrollbar for 10 options */
      height: 400px;
      margin-bottom: 15px;
      flex-grow: 1;
    }
    
    select option {
      padding: 8px;
      margin-bottom: 5px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    select option:hover {
      background-color: var(--light-color);
    }
    
    .input-group {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      position: relative;
    }
    
    .input-group label {
      flex: 1;
      margin-right: 10px;
      font-weight: 500;
    }
    
    .input-group input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }
    
    .input-group input:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .input-group .unit {
      margin-left: 8px;
      color: #666;
      font-size: 13px;
      min-width: 60px;
    }
    
    /* Add this new rule to create a placeholder for fields without units */
    .input-group .no-unit {
      margin-left: 8px;
      min-width: 60px;
      visibility: hidden;
    }
    
    #notes {
      width: 100%;
    }
    
    .output-group {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      position: relative;
    }
    
    .output-group label {
      flex: 1.5;
      margin-right: 10px;
      font-weight: 500;
    }
    
    .output-group input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      background-color: #f8f9fa;
      color: var(--secondary-color);
      font-weight: 600;
    }
    
    .output-group .unit {
      margin-left: 8px;
      color: #666;
      font-size: 13px;
      min-width: 60px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: auto;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn i {
      margin-right: 8px;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2980b9;
    }
    
    .btn-secondary {
      background-color: var(--light-color);
      color: var(--dark-color);
    }
    
    .btn-secondary:hover {
      background-color: #bdc3c7;
    }
    
    canvas {
      width: 100%;
      height: 150px;
      background-color: #f8f9fa;
      border-radius: var(--border-radius);
      margin-top: 20px;
      border: 1px solid #ddd;
    }
    
    .footer {
      margin-top: 30px;
      text-align: center;
      color: #666;
      font-size: 12px;
      padding: 15px;
      border-top: 1px solid #ddd;
    }
    
    .footer a {
      color: var(--primary-color);
      text-decoration: none;
    }
    
    .footer a:hover {
      text-decoration: underline;
    }
    
    /* Toggle for units */
    .toggle-container {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .units-toggle {
      display: flex;
      align-items: center;
      background-color: var(--light-color);
      border-radius: 50px;
      padding: 4px;
      cursor: pointer;
    }
    
    .units-toggle span {
      padding: 6px 12px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .units-toggle .active {
      background-color: white;
      box-shadow: var(--box-shadow);
      color: var(--primary-color);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .calculator-container {
        flex-direction: column;
      }
      
      .card {
        width: 100%;
      }
      
      /* Make select still take good vertical space on mobile */
      select {
        height: 350px;
      }
      
      .input-group, .output-group {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .input-group label, .output-group label {
        margin-bottom: 6px;
      }
      
      .input-group input, .output-group input {
        width: 100%;
      }
      
      .input-group .unit, .input-group .no-unit, .output-group .unit {
        position: absolute;
        right: 10px;
        top: 35px;
      }
    }
  </style>
</head>
<body>
<div class="main-container">
  <div class="header">
    <h1><i class="fas fa-cogs"></i> Online Milling Calculator</h1>
    <div class="units-toggle" id="units-toggle">
      <span class="active" id="imperial">Imperial</span>
      <span id="metric">Metric</span>
    </div>
  </div>
  
  <div class="calculator-container">
    <div class="card cut-selection">
      <h3>Cut Selection</h3>
      <select id="select" size="10">
        <option value="0">0: Default Cut</option>
        <option value="1">1: Custom Cut 1</option>
        <option value="2">2: Custom Cut 2</option>
        <option value="3">3: Custom Cut 3</option>
        <option value="4">4: Custom Cut 4</option>
        <option value="5">5: Custom Cut 5</option>
        <option value="6">6: Custom Cut 6</option>
        <option value="7">7: Custom Cut 7</option>
        <option value="8">8: Custom Cut 8</option>
        <option value="9">9: Custom Cut 9</option>
      </select>
      <div class="btn-group">
        <button id="file_import" class="btn btn-secondary"><i class="fas fa-file-import"></i> Import</button>
        <button id="file_export" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export</button>
      </div>
    </div>
    
    <div class="card inputs">
      <h3>Input Parameters</h3>
      <div id="inputs" class="input-fields">
        <div class="input-group">
          <label for="notes">Name</label>
          <input id="notes" class="input" type="text" value="default">
          <span class="no-unit"></span>
        </div>
        <div class="input-group">
          <label for="uts">Ultimate Tensile Strength</label>
          <input id="uts" class="input" type="number" value="45000" step="100">
          <span class="unit">psi</span>
        </div>
        <div class="input-group">
          <label for="td">Tool Diameter</label>
          <input id="td" class="input" type="number" value="0.25" step="0.05" min="0">
          <span class="unit">in</span>
        </div>
        <div class="input-group">
          <label for="nt">Number of Teeth</label>
          <input id="nt" class="input" type="number" value="2" step="1" min="1">
          <span class="no-unit"></span>
        </div>
        <div class="input-group">
          <label for="ha">Helix Angle</label>
          <input id="ha" class="input" type="number" value="30" step="5" min="0">
          <span class="unit">deg</span>
        </div>
        <div class="input-group">
          <label for="so">Stick Out</label>
          <input id="so" class="input" type="number" value="1.25" step=".05" min="0">
          <span class="unit">in</span>
        </div>
        <div class="input-group">
          <label for="ym">Tool Youngs Modulus</label>
          <input id="ym" class="input" type="number" value="600" step="50" min="0">
          <span class="unit">Gpa</span>
        </div>
        <div class="input-group">
          <label for="wf">Tool Wear Factor</label>
          <input id="wf" class="input" type="number" value="1.2" step="0.05" min="0">
          <span class="no-unit"></span>
        </div>
        <div class="input-group">
          <label for="pe">Power Efficiency</label>
          <input id="pe" class="input" type="number" value="0.75" step="0.05" min="0">
          <span class="no-unit"></span>
        </div>
        <div class="input-group">
          <label for="woc">Radial Width of Cut</label>
          <input id="woc" class="input" type="number" value="0.05" step="0.01" min="0">
          <span class="unit">in</span>
        </div>
        <div class="input-group">
          <label for="doc">Axial Depth of Cut</label>
          <input id="doc" class="input" type="number" value="0.1" step="0.05" min="0">
          <span class="unit">in</span>
        </div>
        <div class="input-group">
          <label for="fpt">Feed Per Tooth</label>
          <input id="fpt" class="input" type="number" value="0.001" step="0.0005" min="0">
          <span class="unit">in/tooth</span>
        </div>
        <div class="input-group">
          <label for="cs">Cutting Speed</label>
          <input id="cs" class="input" type="number" value="1000" step="50" min="0">
          <span class="unit">ft/min</span>
        </div>
      </div>
      
      <div id="inputs_metric" class="input-fields" style="display: none;">
        <div class="input-group">
          <label for="notes">Name</label>
          <input id="notes" class="input" type="text" value="default">
          <span class="no-unit"></span>
        </div>
        <div class="input-group">
          <label for="uts">Ultimate Tensile Strength</label>
          <input id="uts" class="input" type="number" value="310" step="5" min="0">
          <span class="unit">MPa</span>
        </div>
        <div class="input-group">
          <label for="td">Tool Diameter</label>
          <input id="td" class="input" type="number" value="6.25" step=".05" min="0">
          <span class="unit">mm</span>
        </div>
        <div class="input-group">
          <label for="nt">Number of Teeth</label>
          <input id="nt" class="input" type="number" value="2" step="1" min="1">
          <span class="no-unit"></span>
        </div>
        <div class="input-group">
          <label for="ha">Helix Angle</label>
          <input id="ha" class="input" type="number" value="30" step="5" min="0">
          <span class="unit">deg</span>
        </div>
        <div class="input-group">
          <label for="so">Stick Out</label>
          <input id="so" class="input" type="number" value="30" step="0.5" min="0">
          <span class="unit">mm</span>
        </div>
        <div class="input-group">
          <label for="ym">Tool Youngs Modulus</label>
          <input id="ym" class="input" type="number" value="600" step="50" min="0">
          <span class="unit">Gpa</span>
        </div>
        <div class="input-group">
          <label for="wf">Tool Wear Factor</label>
          <input id="wf" class="input" type="number" value="1.2" step="0.05" min="0">
          <span class="no-unit"></span>
        </div>
        <div class="input-group">
          <label for="pe">Power Efficiency</label>
          <input id="pe" class="input" type="number" value="0.75" step="0.05" min="0">
          <span class="no-unit"></span>
        </div>
        <div class="input-group">
          <label for="woc">Radial Width of Cut</label>
          <input id="woc" class="input" type="number" value="1.2" step="0.1" min="0">
          <span class="unit">mm</span>
        </div>
        <div class="input-group">
          <label for="doc">Axial Depth of Cut</label>
          <input id="doc" class="input" type="number" value="2.5" step="0.1" min="0">
          <span class="unit">mm</span>
        </div>
        <div class="input-group">
          <label for="fpt">Feed Per Tooth</label>
          <input id="fpt" class="input" type="number" value="0.025" step="0.005" min="0">
          <span class="unit">mm/tooth</span>
        </div>
        <div class="input-group">
          <label for="cs">Cutting Speed</label>
          <input id="cs" class="input" type="number" value="300" step="50" min="0">
          <span class="unit">m/min</span>
        </div>
      </div>
    </div>
    
    <div class="card outputs">
      <h3>Results</h3>
      <div id="outputs" class="output-fields">
        <div class="output-group">
          <label for="rpm">RPM</label>
          <input id="rpm" class="output" type="number" value="10000" readonly>
          <span class="unit">r/min</span>
        </div>
        <div class="output-group">
          <label for="fr">Feed Rate</label>
          <input id="fr" class="output" type="number" value="10000" readonly>
          <span class="unit">in/min</span>
        </div>
        <div class="output-group">
          <label for="mrr">Material Removal Rate</label>
          <input id="mrr" class="output" type="number" value="0.15279" readonly>
          <span class="unit">in<sup>3</sup>/min</span>
        </div>
        <div class="output-group">
          <label for="ct">Chip Thickness</label>
          <input id="ct" class="output" type="number" value="0.0008" readonly>
          <span class="unit">in</span>
        </div>
        <div class="output-group">
          <label for="pat">Power at Tool</label>
          <input id="pat" class="output" type="number" value="0.04591" readonly>
          <span class="unit">HP</span>
        </div>
        <div class="output-group">
          <label for="pam">Power at Motor</label>
          <input id="pam" class="output" type="number" value="0.04591" readonly>
          <span class="unit">HP</span>
        </div>
        <div class="output-group">
          <label for="tcf">Tangential Cutting Force</label>
          <input id="tcf" class="output" type="number" value="1.51511" readonly>
          <span class="unit">lbf</span>
        </div>
        <div class="output-group">
          <label for="td">Average Tool Deflection</label>
          <input id="td" class="output" type="number" value="0.00011" readonly>
          <span class="unit">in</span>
        </div>
        <div class="output-group">
          <label for="picf">Peak Instantaneous Cutting Force</label>
          <input id="picf" class="output" type="number" value="0.012" readonly>
          <span class="unit">lbf</span>
        </div>
      </div>
      
      <div id="outputs_metric" class="output-fields" style="display: none;">
        <div class="output-group">
          <label for="rpm">RPM</label>
          <input id="rpm" class="output" type="number" value="10000" readonly>
          <span class="unit">r/min</span>
        </div>
        <div class="output-group">
          <label for="fr">Feed Rate</label>
          <input id="fr" class="output" type="number" value="10000" readonly>
          <span class="unit">mm/min</span>
        </div>
        <div class="output-group">
          <label for="mrr">Material Removal Rate</label>
          <input id="mrr" class="output" type="number" value="0.15279" readonly>
          <span class="unit">cm<sup>3</sup>/min</span>
        </div>
        <div class="output-group">
          <label for="ct">Chip Thickness</label>
          <input id="ct" class="output" type="number" value="0.0008" readonly>
          <span class="unit">mm</span>
        </div>
        <div class="output-group">
          <label for="pat">Power at Tool</label>
          <input id="pat" class="output" type="number" value="0.04591" readonly>
          <span class="unit">W</span>
        </div>
        <div class="output-group">
          <label for="pam">Power at Motor</label>
          <input id="pam" class="output" type="number" value="0.04591" readonly>
          <span class="unit">W</span>
        </div>
        <div class="output-group">
          <label for="tcf">Tangential Cutting Force</label>
          <input id="tcf" class="output" type="number" value="1.51511" readonly>
          <span class="unit">N</span>
        </div>
        <div class="output-group">
          <label for="td">Average Tool Deflection</label>
          <input id="td" class="output" type="number" value="0.00011" readonly>
          <span class="unit">mm</span>
        </div>
        <div class="output-group">
          <label for="picf">Peak Instantaneous Cutting Force</label>
          <input id="picf" class="output" type="number" value="0.01" readonly>
          <span class="unit">N</span>
        </div>
      </div>
      
      <canvas id="graph" width="360" height="100"></canvas>
    </div>
  </div>
  
  <div class="footer">
    <p>These calculations are based upon theoretical values and are only intended for planning purposes. Actual results will vary. No responsibility is assumed. <a href="https://github.com/joevenzon/cutcalculator">(source)</a></p>
  </div>

</div>
  
  <script>

        var KEYCODE_SHIFT = 16;
        var KEYCODE_CTRL = 17;
        var g_shift = false;
        var g_ctrl = false;
        var g_inputsHolder = document.getElementById("inputs");
        var g_outputsHolder = document.getElementById("outputs");
        var g_inputsMetricHolder = document.getElementById("inputs_metric");
        var g_outputsMetricHolder = document.getElementById("outputs_metric");
        var g_importButton = document.getElementById("file_import");
        var g_exportButton = document.getElementById("file_export");
        var g_unitsButton = document.getElementById("units-toggle");
        var g_canvas = document.getElementById('graph');
        var g_ctx = g_canvas.getContext('2d');
        var g_metric = false;
        var g_version = 7;
        var g_default = "notes=default;uts=45000;td=0.25;nt=2;ha=30;so=1.25;ym=600;wf=1.2;pe=0.75;woc=0.05;doc=0.1;fpt=0.001;cs=1000;";
        var g_selectList = document.getElementById("select");
        var g_cutCount = 10;
        var g_cuts = [];

        function save()
        {
            console.log("saving...");

            // write the input values to html attributes so they'll get saved
            /*for (var i = 0; i < g_inputsHolder.children.length; i++)
            {
                var editInput = getNumberInput(g_inputsHolder.children[i]);
                editInput.setAttribute("value", editInput.value);
            }
            for (var i = 0; i < g_inputsMetricHolder.children.length; i++)
            {
                var editInput = getNumberInput(g_inputsMetricHolder.children[i]);
                editInput.setAttribute("value", editInput.value);
            }*/

            var blob = serializeInputs();
            var curcut = g_selectList.selectedIndex;
            console.log("cut" + curcut + " = " + blob);
            g_cuts[curcut] = blob;
            updateCutTitles();

            //console.log(g_inputsHolder.innerHTML);
            //localStorage.setItem("inputs", blob);
            for (var i = 0; i < g_cuts.length && i < g_cutCount; i++)
            {
                localStorage.setItem("cut" + i, g_cuts[i]);
            }
            localStorage.setItem("metric", (g_metric ? "true" : "false"));
            localStorage.setItem("version", g_version);
        }

        function load()
        {
            if (localStorage.getItem("version") == g_version)
            {
                console.log("loading...")

                g_metric = (localStorage.getItem("metric") == "true" ? true : false);

                for (var i = 0; i < g_cuts.length && i < g_cutCount; i++)
                {
                    var cutname = "cut" + i;
                    if (localStorage.getItem(cutname))
                    {
                        var blob = localStorage.getItem(cutname);
                        console.log(cutname + " = " + blob);
                        g_cuts[i] = blob;
                    }
                }
                g_selectList.selectedIndex = 0;
                selectCut(0);
                updateCutTitles();
                updateUnits();
                recompute();
            }
            else
            {
                console.log("version mismatch, not loading: " + localStorage.getItem("version") + " because it's not our version " + g_version);
            }
        }

        function getNumberInput(listItem)
        {
            if (listItem == null)
                return null;

            //return listItem.querySelector('input.input[type=number]');
            return listItem.querySelector('input.input');
        }

        function keyPressHandler(keyEvent)
        {
            var KEYCODE_ENTER = 13;

            if (keyEvent.keyCode == KEYCODE_ENTER)
            {
            }
            //else console.log(keyEvent.keyCode);
        }

        function keyDownHandler(keyEvent)
        {
            var KEYCODE_ESC = 27;
            var KEYCODE_ENTER = 13;
            var KEYCODE_LEFT = 37;
            var KEYCODE_UP = 38;
            var KEYCODE_RIGHT = 39;
            var KEYCODE_DOWN = 40;
            var KEYCODE_TAB = 9;
            var KEYCODE_BACKSPACE = 8;
            var KEYCODE_DEL = 46;

            if (keyEvent.keyCode == KEYCODE_ESC || keyEvent.keyCode == KEYCODE_ENTER)
            {
                console.log("blur");
                this.blur();

                return false;
            }
            else if (keyEvent.keyCode == KEYCODE_UP)
            {
                var listItem = this.parentNode;
                var ul = listItem.parentNode;
                var sibling = listItem.previousElementSibling;
                if (sibling != null && listItem != ul.firstElementChild)
                {
                    /*if (g_shift)
                    {
                        ul.insertBefore(listItem, sibling);
                        getTextInput(listItem).focus();
                        listItem.scrollIntoView();
                    }
                    else*/
                    {
                        getTextInput(sibling).focus();
                        sibling.scrollIntoView();
                    }
                }

                return false;
            }
            else if (keyEvent.keyCode == KEYCODE_DOWN)
            {
                var listItem = this.parentNode;
                var ul = listItem.parentNode;
                var sibling = listItem.nextElementSibling;
                if (sibling != null && listItem != ul.lastElementChild)
                {
                    /*if (g_shift)
                    {
                        if (sibling != ul.lastElementChild)
                        {
                            ul.insertBefore(listItem, sibling.nextElementSibling);
                        }
                        else
                        {
                            ul.appendChild(listItem);
                        }

                        getTextInput(listItem).focus();
                        listItem.scrollIntoView();
                    }
                    else*/
                    {
                        getTextInput(sibling).focus();
                        sibling.scrollIntoView();
                    }
                }

                return false;
            }
            //else console.log(keyEvent.keyCode);
        }

        function globalKeyDown(keyEvent)
        {
            if (keyEvent.keyCode == KEYCODE_SHIFT)
            {
                g_shift = true;
            }
            else if (keyEvent.keyCode == KEYCODE_CTRL)
            {
                g_ctrl = true;
            }
        }

        function globalKeyUp(keyEvent)
        {
            if (keyEvent.keyCode == KEYCODE_SHIFT)
            {
                g_shift = false;
            }
            else if (keyEvent.keyCode == KEYCODE_CTRL)
            {
                g_ctrl = false;
            }
        }

        function getInput(id, metric_conversion)
        {
            if (g_metric)
                return parseFloat(g_inputsMetricHolder.querySelector('#'+id).value)/metric_conversion;
            else
                return parseFloat(g_inputsHolder.querySelector('#'+id).value);
        }

        function setOutput(id, value, decimals, metric_conversion)
        {
            if (g_metric)
                g_outputsMetricHolder.querySelector('#'+id).value = parseFloat((value*metric_conversion).toFixed(decimals));
            else
                g_outputsHolder.querySelector('#'+id).value = parseFloat(value.toFixed(decimals));
        }

        function saturate(x)
        {
            if (x > 1) return 1;
            if (x < 0) return 0;
            return x;
        }

        function lerp(x, y, s)
        {
            return x + s * (y - x);
        }

        function recompute()
        {
            /*
            <li>Ultimate Tensile Strength<input id="uts" class="input" type="number" value="45000">psi</li>
            <li>Tool Diameter<input id="td" class="input" type="number" value="0.25">in</li>
            <li>Number of Teeth<input id="nt" class="input" type="number" value="2"></li>
            <li>Helix Angle<input id="ha" class="input" type="number" value="30">deg</li>
            <li>Stick Out<input id="so" class="input" type="number" value="1.25">in</li>
            <li>Tool Youngs Modulus<input id="ym" class="input" type="number" value="600">Gpa</li>
            <li>Tool Wear Factor<input id="wf" class="input" type="number" value="1.2"></li>
            <li>Radial Width of Cut<input id="woc" class="input" type="number" value="0.05">in</li>
            <li>Axial Depth of Cut<input id="doc" class="input" type="number" value="0.1">in</li>
            <li>Feed Per Tooth<input id="fpt" class="input" type="number" value="0.001">in/tooth</li>
            <li>Cutting Speed<input id="cs" class="input" type="number" value="1000">ft/min</li>

            <li>RPM<input id="rpm" class="output" type="number" value="10000">r/min</li>
            <li>Feed Rate<input id="fr" class="output" type="number" value="10000">in/min</li>
            <li>Material Removal Rate<input id="mrr" class="output" type="number" value="0.15279">in^3/min</li>
            <li>Chip Thickness<input id="ct" class="output" type="number" value="0.0008">in</li>
            <li>Power at Tool<input id="pat" class="output" type="number" value="0.04591">HP</li>
            <li>Tangential Cutting Force<input id="tcf" class="output" type="number" value="1.51511">lbf</li>
            <li>Tool Deflection<input id="td" class="output" type="number" value="0.00011">in</li>
            <li>Peak Instantaneous Cutting Force<input id="picf" class="output" type="number" value="0.012" readonly>lbf</li>*/

            var uts = getInput("uts",0.00689476);
            var td = getInput("td",25.4);
            var nt = getInput("nt",1);
            var ha = getInput("ha",1);
            var so = getInput("so",25.4);
            var ym = getInput("ym",1);
            var wf = getInput("wf",1);
            var pe = getInput("pe",1);
            var woc = getInput("woc",25.4);
            var doc = getInput("doc",25.4);
            var fpt = getInput("fpt",25.4);
            var cs = getInput("cs",0.3048);

            var mpc = uts/292207; //derived from aluminum, assuming linear relationship
            var rpm = 12*cs/(Math.PI*td);
            var fr = rpm * fpt * nt;
            var mrr = fr * doc * woc;
            var eangle = Math.acos(1.0 - woc / (td*0.5)) * (180/Math.PI);
            var ctangle = Math.min(90, eangle);
            var ct = fpt*Math.sin(ctangle * Math.PI / 180);
            var ff = 0.417 * Math.pow(fpt, -0.197);
            var pat = ff * mpc * wf * mrr;
            var pam = pat/pe;
            var tcf = pat * 550 / (cs/60);
            //var woverd = woc / td;
            //var efactor = lerp(1.0, 1.1, saturate((woverd - 0.66)/0.34)); // for aluminum...
            //var tcf = uts * doc * fpt * nt * (eangle/360) * efactor * wf;
            var def = (tcf * Math.pow(so,3)) / (3 * ym * 145037 * 1.75 * Math.pow(td,4)/64);

            setOutput("rpm",Math.round(rpm),1,1);
            setOutput("fr",fr,2,25.4);
            setOutput("mrr",mrr,4,16.387064);
            setOutput("ct",ct,5,25.4);
            setOutput("pat",pat,2,745.7);
            setOutput("pam",pam,2,745.7);
            setOutput("tcf",tcf,2,4.44822);
            setOutput("td",def,5,25.4);
            // note one more setOutput, below

            let forces = [];
            var k_z_resolution = Math.max(0.001, doc/100);
            var toolradius = td / 2;
            var angleStep = 1; // degrees per step
            var Fcmax = 0;
            for (var angle = 0; angle < 360; angle += angleStep)
            {
                var total = 0;

                for (var tooth = 0; tooth < nt; tooth++)
                {
                    var toothStartAngle = angle + 360 * (tooth / nt);
                    var toothResult = 0;

                    for (var z = doc; z >= 0; z -= k_z_resolution)
                    {
                        var toothAngle = toothStartAngle + (180 / Math.PI) * (-z) * Math.tan(ha * (Math.PI / 180)) / toolradius;
                        toothAngle = toothAngle - 360 * Math.floor(toothAngle / 360); //wrap

                        var engagementAngle = Math.acos(1.0 - woc / toolradius) * (180 / Math.PI);
                        var engagementStartAngle = 180 - engagementAngle;

                        var chipThickness = 0;

                        if (toothAngle > engagementStartAngle && toothAngle < 180)
                        {
                            chipThickness = fpt * Math.sin(toothAngle * (Math.PI / 180));
                        }

                        var materialRemoved = chipThickness * k_z_resolution * Math.sin(angleStep * Math.PI / 180) * toolradius;

                        toothResult += materialRemoved;
                    }

                    total += toothResult;
                }

                var mrr = total*rpm;
                var feedfactor = 0.417 * Math.pow(fpt, -0.197);
                var powertool = feedfactor * mpc * wf * mrr;
                var Fc = powertool * 550 / (cs / 60);
                Fcmax = Math.max(Fc,Fcmax);

                forces.push(Fc);
            }

            setOutput("picf",Fcmax*360/angleStep,2,4.44822);

            var height = 100;
            g_ctx.fillStyle = 'rgb(220, 220, 220)';
            g_ctx.fillRect(0,0,360,height);
            g_ctx.beginPath();
            g_ctx.moveTo(0,height-forces[0]/Fcmax*height);
            for (var i = 1; i < forces.length; i++)
            {
                g_ctx.lineTo(i,height-forces[i]/Fcmax*height);
            }
            //console.log("Fc_max: " + Fcmax);
            //g_ctx.closePath();
            g_ctx.stroke();
        }
    
        function onblur()
        {
            updateNonMetricInputs();
            recompute();
            save();
        }

        function bindTaskEvents(taskListItem)
        {
            console.log("bind list item events");

            var editInput = getNumberInput(taskListItem);
            editInput.onkeypress = keyPressHandler;
            editInput.onkeydown = keyDownHandler;
            editInput.onblur = onblur;
            editInput.onchange = onblur;
        }

        function exportFile()
        {
            save();

            // toggle units twice to mirror settings to both metric & imperial inputs
            toggleUnits();
            toggleUnits();

            var filename = "exported_cut.txt";
            var file = new Blob([serializeInputs()], {type: "text/plain"});
            if (window.navigator.msSaveOrOpenBlob) // IE10+
            {
                window.navigator.msSaveOrOpenBlob(file, filename);
            }
            else { // Others
                var a = document.createElement("a"),
                url = URL.createObjectURL(file);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function() {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);  
                }, 0); 
            }
        }

        function importFile()
        {
            console.log("import: file chooser...");
            var fileInput = document.createElement("input");
            fileInput.id = "file_chooser";
            fileInput.type = "file";
            fileInput.click();
            fileInput.addEventListener('change', importFileInternal, false);
        }

        function importFileInternal()
        {
            var fileInput = this;
            var files = fileInput.files;
            var file = files[0];
            console.log("importing from " + file.name);
            var reader = new FileReader();
            reader.onload = function(event) {
                console.log(event.target.result);
                deserializeInputs(event.target.result);
                updateCutTitles();
                recompute();
            }
            reader.readAsText(file);
        }

        function onCutSelectionChange()
        {
            selectCut(this.selectedIndex);
        }

        function selectCut(index)
        {
            //console.log("selecting " + index);
            deserializeInputs(g_cuts[index]);
            recompute();
        }

        function bindAllTaskEvents()
        {
            for (var i = 0; i < g_inputsHolder.children.length; i++)
            {
                bindTaskEvents(g_inputsHolder.children[i]);
            }
            for (var i = 0; i < g_inputsMetricHolder.children.length; i++)
            {
                bindTaskEvents(g_inputsMetricHolder.children[i]);
            }
            g_selectList.onchange = onCutSelectionChange;
        }

        function convertInput(id,metric_conversion)
        {
            if (g_metric)
            {
                var value = parseFloat(g_inputsHolder.querySelector('#'+id).value);
                g_inputsMetricHolder.querySelector('#'+id).value = parseFloat((value*metric_conversion).toPrecision(7));
            }
            else
            {
                var value = parseFloat(g_inputsMetricHolder.querySelector('#'+id).value);
                // Higher precision for (non-clean) division helps round trip round values.
                g_inputsHolder.querySelector('#'+id).value = parseFloat((value/metric_conversion).toPrecision(8));
            }
        }

        function convertText(id)
        {
            if (g_metric)
            {
                var value = g_inputsHolder.querySelector('#'+id).value;
                g_inputsMetricHolder.querySelector('#'+id).value = value;
            }
            else
            {
                var value = g_inputsMetricHolder.querySelector('#'+id).value;
                g_inputsHolder.querySelector('#'+id).value = value;
            }
        }

        function updateNonMetricInputs()
        {
            if (g_metric)
            {
                g_metric = false;

                convertText("notes");
                convertInput("uts",0.00689476);
                convertInput("pe",1);
                convertInput("td",25.4);
                convertInput("nt",1);
                convertInput("ha",1);
                convertInput("so",25.4);
                convertInput("ym",1);
                convertInput("wf",1);
                convertInput("woc",25.4);
                convertInput("doc",25.4);
                convertInput("fpt",25.4);
                convertInput("cs",0.3048);

                g_metric = true;
            }
            else
            {
                // already active, so already updated
            }
        }

        function updateMetricInputs(force)
        {
            if (!g_metric || force)
            {
                g_metric = true;

                convertText("notes");
                convertInput("uts",0.00689476);
                convertInput("pe",1);
                convertInput("td",25.4);
                convertInput("nt",1);
                convertInput("ha",1);
                convertInput("so",25.4);
                convertInput("ym",1);
                convertInput("wf",1);
                convertInput("woc",25.4);
                convertInput("doc",25.4);
                convertInput("fpt",25.4);
                convertInput("cs",0.3048);

                g_metric = false;
            }
            else
            {
                // already active, so already updated
            }
        }

        function toggleUnits()
        {
            g_metric = !g_metric;
            updateUnits();
            convertText("notes");
            convertInput("uts",0.00689476);
            convertInput("pe",1);
            convertInput("td",25.4);
            convertInput("nt",1);
            convertInput("ha",1);
            convertInput("so",25.4);
            convertInput("ym",1);
            convertInput("wf",1);
            convertInput("woc",25.4);
            convertInput("doc",25.4);
            convertInput("fpt",25.4);
            convertInput("cs",0.3048);
            recompute();
            save();
            console.log("toggled units");
        }

        function updateUnits()
        {
            // Remove active class from all spans
            const spans = g_unitsButton.querySelectorAll('span');
            spans.forEach(span => span.classList.remove('active'));

            if (g_metric)
            {
                g_unitsButton.querySelector('#metric').classList.add('active');
                g_inputsHolder.style.display = "none";
                g_outputsHolder.style.display = "none";
                g_inputsMetricHolder.style.display = "block";
                g_outputsMetricHolder.style.display = "block";
            }
            else
            {
                g_unitsButton.querySelector('#imperial').classList.add('active');
                g_inputsHolder.style.display = "block";
                g_outputsHolder.style.display = "block";
                g_inputsMetricHolder.style.display = "none";
                g_outputsMetricHolder.style.display = "none";
            }
        }

        function serializeInputs()
        {
            var result = "";

            updateNonMetricInputs();

            for (var i = 0; i < g_inputsHolder.children.length; i++)
            {
                var node = g_inputsHolder.children[i].querySelector('input');
                var value = node.value;
                value = value.replace(";",",");
                value = value.replace("=","-");
                result = result + node.id + "=" + value + ";";
            }

            return result;
        }

        function deserializeInputs(blob)
        {
            var inputs = blob.split(";");

            for (var i = 0; i < inputs.length; i++)
            {
                if (inputs[i] != "")
                {
                    var assignment = inputs[i].split("=");
                    var id = assignment[0];
                    var node = g_inputsHolder.querySelector("#" + id);
                    if (node == null)
                    {
                        console.log("error: can't find #" + id);
                    }
                    else
                    {
                        node.value = assignment[1];
                    }
                }
            }

            updateMetricInputs(true);
        }

        function getNotesFromBlob(blob)
        {
            var inputs = blob.split(";");

            for (var i = 0; i < inputs.length; i++)
            {
                if (inputs[i] != "")
                {
                    var assignment = inputs[i].split("=");
                    var id = assignment[0];
                    if (id == "notes")
                    {
                        return assignment[1];
                    }
                }
            }

            return "";
        }

        function setupCuts()
        {
            for (var i = 0; i < g_cutCount; i++)
            {
                g_cuts[i] = g_default;
            }
        }

        function updateCutTitles()
        {
            for (var i = 0; i < g_selectList.children.length; i++)
            {
                var child = g_selectList.children[i];
                child.innerText = i + ": " + getNotesFromBlob(g_cuts[i]);
            }
        }

        function initialize()
        {
            setupCuts();

            load();

            //document.onkeydown = globalKeyDown;
            //document.onkeyup = globalKeyUp;

            g_importButton.onclick = importFile;
            g_exportButton.onclick = exportFile;
            g_unitsButton.onclick = toggleUnits;

            bindAllTaskEvents();

            updateCutTitles();
            g_selectList.selectedIndex = 0;
            selectCut(0);

            updateUnits();

            recompute();
        }

        initialize();

    </script>
  </body>
</html>

